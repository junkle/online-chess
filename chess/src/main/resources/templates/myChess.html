<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" xmlns:pd="http://www.w3.org/1999/xhtml">
	<head>
		<meta charset="UTF-8">
		<title>象棋盘</title>

		<link  th:href="@{/css/bootstrap.css}" rel="stylesheet" type="text/css" />

	</head>

	<body class="container" th:background="@{/img/background/battle.jpg}">
		<canvas id="canvas" class="center-block " width="540px" height="600px"></canvas>
		<div style="display: none" >
			<img th:src="@{/img/chess/black_army.gif}" id="black_army">
			<img th:src="@{/img/chess/red_army.gif}" id="red_army">
			<img th:src="@{/img/chess/red_cannon.gif}" id="red_cannon">
			<img th:src="@{/img/chess/black_cannon.gif}" id="black_cannon">
			<img th:src="@{/img/chess/black_car.gif}" id="black_car">
			<img th:src="@{/img/chess/red_car.gif}" id="red_car">
			<img th:src="@{/img/chess/red_elephant.gif}" id="red_elephant">
			<img th:src="@{/img/chess/black_elephant.gif}" id="black_elephant">
			<img th:src="@{/img/chess/black_general.gif}" id="black_general">
			<img th:src="@{/img/chess/red_general.gif}" id="red_general">
			<img th:src="@{/img/chess/black_house.gif}" id="black_house">
			<img th:src="@{/img/chess/red_house.gif}" id="red_house">
			<img th:src="@{/img/chess/red_soldier.gif}" id="red_soldier">
			<img th:src="@{/img/chess/black_soldier.gif}" id="black_soldier">
		</div>
	</body>

	<script  th:src="@{/js/jquery-3.1.1.min.js}" type="text/javascript"></script>
	<script  th:src="@{/js/bootstrap.js}" type="text/javascript"></script>
	<script>
        window.onload = function() {
            $(function () {
                var canvas_jquery = $("#canvas");
                var canvas = canvas_jquery[0];
                var ctx = canvas.getContext("2d");
                var signSize = 8;
                var signSpace = 3;
                var chessWidth = 50, chessHeight = 50;
                var fontSize = 40;
                //是否为第一次点击棋子
                var firstClick = true;
                //保存点击的棋子
                var clickChess;
                var myUser = 'black';
                var otherUser = 'red';
                //棋盘的线个数
                var xNum = 9, yNum = 5 * 2;
                //棋线间隔93
                var space = 60;
                //有效的坐标
                var validCoordinate = [];
                //当前象棋状态
                var chessStatus = [];
                //棋盘线条颜色
                ctx.strokeStyle = "black";
                //棋盘外框起始坐标
                var blackRect = new Coordinate(20, 20);
                //棋盘外边框的宽和高
                var blackRectWidth = 490, blackRectHeight = 550;
                //将棋盘视为以左上角 （10，10） 为圆点的坐标轴
                var start = new Coordinate(blackRect.x + 5, blackRect.y + 5);
                var end = new Coordinate(getCoordinateX(xNum - 1), getCoordinateY(yNum - 1));
                //初始化数据
                initData();
                //初始化界面
                initUI();
                //初始化事件
                initEvent();

                function initUI() {
                    //棋盘外框线宽
                    ctx.lineWidth = 4;
					//绘制棋盘外框
                    drawBlackRect();
                    //棋盘线宽
                    ctx.lineWidth = 2;
                    //绘制棋盘
                    drawChessBoard();
                    //绘制四条斜线
                    drawSlash();
                    //画*花标志
                    drawAllSign();
                    //初始化棋盘位置
                    drawChess();
                    //绘制楚河汉界
                    drawFont();
                }

                function initData() {
                    //保存有效坐标
                    saveValidCoordinate();
                    //保存当前的象棋的状态
                    saveChessStatus();
                }

                function initEvent() {
                    canvas_jquery.on('click', function (e) {
                        var point = getPointOnCanvas(e.clientX, e.clientY);
                        //得到距离鼠标最近的画布坐标
                        var nearest = getNearestCoordinate(point);
                        var currChess = chessStatus[nearest.x + "," + nearest.y];
                        if (currChess == null) {
                            //如果已经选中己方棋子并且第一次点击空空棋盘位置 准备移动
                            if (!firstClick) {
                                //TODO  准备移动  做校验 能否移动
                                firstClick = chessMove(clickChess, nearest);
                                //如果第一次点击空白区域  不做任何处理
                            } else {
                                return ;
                            }
                            //如果当前点击的棋子是当前用户
                        } else if (currChess.split("_")[0] === myUser) {
                            clickChess = nearest;
                            firstClick = false;
                            //TODO  如果已经点击了自己的棋子 并且准备吃掉敌方棋子 做校验 能否移动
                        } else if (currChess.split("_")[0] === otherUser && !firstClick) {
                            chessMove(clickChess, nearest);
                        }
                    })
                }
                /**
                 *
                 * 准备棋子移动  首先校验棋子的有效性
				 * clearRect会自动清除移动之前位置的所有棋子  所以不用判断此次移动是吃子还是移动
                 * @param pointX 开始移动的位置
                 * @param pointY 结束移动的位置
                 **/
                function chessMove(pointX, pointY) {
					var chessName = chessStatus[pointX.x + "," + pointX.y];
					if (!canMove(chessName, pointX, pointY)) {
					    return false;
					}
                    chessStatus[pointX.x + "," + pointX.y] = null;
                    chessStatus[pointY.x + "," + pointY.y] = chessName;
                    drawImage($('#' + chessName)[0], pointY.x, pointY.y);
                    ctx.clearRect(getCoordinateX(pointX.x) - chessWidth / 2, getCoordinateY(pointX.y) - chessHeight / 2, chessWidth, chessHeight);
                    initUI();
                    ctx.save();
                    return true;
                }
                //TODO  校验可行性
                function canMove(chessName, pointX, pointY) {
					return true;
                }
                /**
                 * 四舍五入计算最近的棋盘位置
                 * @param point	当前坐标
                 **/
                function getNearestCoordinate(point) {
                    return new Coordinate(Math.floor((point.x - start.x) / space + 0.5), Math.floor((point.y - start.y) / space + 0.5));

                }
                /**
                 * 获得当前鼠标在canvas上的坐标
                 *@param x	实际坐标
                 *@param y	实际坐标
                 *
                 **/
                function getPointOnCanvas(x, y) {
                    var rect = canvas.getBoundingClientRect();
                    return { x: Math.round((x - rect.left ) * (canvas.width / rect.width)),
                        y: Math.round((y - rect.top) * (canvas.height / rect.height))
                    };
                }
                //绘制棋子
                function drawChess() {
                    var point;
                    for(var key in chessStatus) {
                        if (key ==null || chessStatus[key] == null) {
                            continue;
						}
                        point = key.split(",");
                        drawImage($('#' + chessStatus[key])[0], point[0], point[1]);
					};
                }
                //得到相对于棋盘的X坐标位置
                function getCoordinateX(num) {
                    return start.x + space * num;
                }
                //得到相对于棋盘的Y坐标位置
                function getCoordinateY(num) {
                    return start.y + space * num;
                }
                //在 (x,y)处绘制图片image
                function drawImage(image, x, y) {
                    ctx.drawImage(image, getCoordinateX(x) - chessWidth / 2, getCoordinateY(y) - chessHeight / 2, chessWidth, chessHeight);
                }
                //绘制所有的*花
                function drawAllSign() {
                    sign(getCoordinateX(1), getCoordinateY(2), 2);
                    sign(getCoordinateX(1), getCoordinateY(7), 2);
                    sign(getCoordinateX(7), getCoordinateY(2), 2);
                    sign(getCoordinateX(7), getCoordinateY(7), 2);

                    sign(getCoordinateX(0), getCoordinateY(3), 1);
                    sign(getCoordinateX(2), getCoordinateY(3), 2);
                    sign(getCoordinateX(4), getCoordinateY(3), 2);
                    sign(getCoordinateX(6), getCoordinateY(3), 2);
                    sign(getCoordinateX(8), getCoordinateY(3), 0);

                    sign(getCoordinateX(0), getCoordinateY(6), 1);
                    sign(getCoordinateX(2), getCoordinateY(6), 2);
                    sign(getCoordinateX(4), getCoordinateY(6), 2);
                    sign(getCoordinateX(6), getCoordinateY(6), 2);
                    sign(getCoordinateX(8), getCoordinateY(6), 0);
                }
                //绘制棋盘
                function drawChessBoard() {
                    var cnt_x = 0, cnt_y = 0;
                    //横线
                    for (var i = start.x; cnt_x < xNum; i = i + space, cnt_x++) {
                        //绘制红方横线
                        drawLine(i, start.y, i, getCoordinateY(4));
                        //绘制黑方横线
                        drawLine(i, getCoordinateY(5), i, end.y);
                    }
                    //竖线
                    for (var j = start.y; cnt_y < yNum; j = j + space, cnt_y++) {
                        drawLine(start.x, j, end.x, j);
                    }
                }
                //绘制四条斜线
                function drawSlash() {
                    drawLine(getCoordinateX(3), getCoordinateY(0), getCoordinateX(5), getCoordinateY(2));
                    drawLine(getCoordinateX(3), getCoordinateY(7), getCoordinateX(5), getCoordinateY(9));
                    drawLine(getCoordinateX(3), getCoordinateY(2), getCoordinateX(5), getCoordinateY(0));
                    drawLine(getCoordinateX(3), getCoordinateY(9), getCoordinateX(5), getCoordinateY(7));
                }
                //绘制楚河汉界
                function drawFont() {
                    ctx.save();
                    ctx.font = fontSize + "px microsoft yahei";
                    var size = fontSize / 2;
                    ctx.fillText('楚', getCoordinateX(2) - size, getCoordinateY(5) - size);
                    ctx.fillText('河', getCoordinateX(3) - size, getCoordinateY(5) - size);
                    ctx.fillText('汉', getCoordinateX(5) - size, getCoordinateY(5) - size);
                    ctx.fillText('界', getCoordinateX(6) - size, getCoordinateY(5) - size);
                }
                //保存有效的坐标位置
                function saveValidCoordinate() {
                    var index;
                    for (var i = 0; i < xNum; i++) {
                        for(var j = 0; j < yNum - 1; j++) {
                            index = i + "," + j;
                            chessStatus[index] = null;
                            validCoordinate[index] = new Coordinate(getCoordinateX(i), getCoordinateY(j));
                        }
                    }
                }
                //保存初始时的象棋状态
                function saveChessStatus() {
                    chessStatus["0,3"] = "red_army";
                    chessStatus["2,3"] = "red_army";
                    chessStatus["4,3"] = "red_army";
                    chessStatus["6,3"] = "red_army";
                    chessStatus["8,3"] = "red_army";
                    chessStatus["0,0"] = "red_car";
                    chessStatus["8,0"] = "red_car";
                    chessStatus["1,0"] = "red_house";
                    chessStatus["7,0"] = "red_house";
                    chessStatus["2,0"] = "red_elephant";
                    chessStatus["6,0"] = "red_elephant";
                    chessStatus["3,0"] = "red_soldier";
                    chessStatus["5,0"] = "red_soldier";
                    chessStatus["1,2"] = "red_cannon";
                    chessStatus["7,2"] = "red_cannon";
                    chessStatus["4,0"] = "red_general";
                    chessStatus["0,6"] = "black_army";
                    chessStatus["2,6"] = "black_army";
                    chessStatus["4,6"] = "black_army";
                    chessStatus["6,6"] = "black_army";
                    chessStatus["8,6"] = "black_army";
                    chessStatus["0,9"] = "black_car";
                    chessStatus["8,9"] = "black_car";
                    chessStatus["1,9"] = "black_house";
                    chessStatus["7,9"] = "black_house";
                    chessStatus["2,9"] = "black_elephant";
                    chessStatus["6,9"] = "black_elephant";
                    chessStatus["3,9"] = "black_soldier";
                    chessStatus["5,9"] = "black_soldier";
                    chessStatus["1,7"] = "black_cannon";
                    chessStatus["7,7"] = "black_cannon";
                    chessStatus["4,9"] = "black_general";
                }
                /**
                 * 绘制棋盘线
                 * @param x_s	起始坐标x
                 * @param y_s	起始坐标y
                 * @param x_e	结束坐标x
                 * @param y_e	结束坐标y
                 */
                function drawLine(x_s, y_s, x_e, y_e) {
                    ctx.beginPath();
                    ctx.moveTo(x_s, y_s);
                    ctx.lineTo(x_e, y_e);
                    ctx.stroke();
                }

                /**
                 * 坐标对象
                 * @param x	x坐标
                 * @param y	y坐标
                 */
                function Coordinate(x, y) {
                    this.x = x;
                    this.y = y;
                }
                /**
                 * 画*花标志
                 * @param x	坐标x
                 * @param y	坐标y
                 */
                function sign(x, y, type) {
                    //右边*花
                    if (type != 0) {
                        drawLine(x + signSpace, y + signSpace, x + signSpace, y + signSpace + signSize);
                        drawLine(x + signSpace, y + signSpace, x + signSpace + signSize, y + signSpace);

                        drawLine(x + signSpace, y - signSpace, x + signSpace, y - signSpace - signSize);
                        drawLine(x + signSpace, y - signSpace, x + signSpace + signSize, y - signSpace);
                    }

                    //左边*花
                    if (type != 1) {
                        drawLine(x - signSpace, y - signSpace, x - signSpace, y - signSpace - signSize);
                        drawLine(x - signSpace, y - signSpace, x - signSpace - signSize, y - signSpace);

                        drawLine(x - signSpace, y + signSpace, x - signSpace, y + signSpace + signSize);
                        drawLine(x - signSpace, y + signSpace, x - signSpace - signSize, y + signSpace);
                    }
                }
				//绘制棋盘外边框
                function drawBlackRect() {
                    ctx.strokeRect(blackRect.x, blackRect.y, blackRectWidth, blackRectHeight);
                }
            });
		}

	</script>
</html>